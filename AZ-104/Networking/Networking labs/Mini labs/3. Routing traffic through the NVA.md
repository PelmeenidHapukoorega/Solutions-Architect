# Mini lab 3: Routing traffic through the NVA

Now that i had the NVA and necessary VMs i needed to route the traffic through the NVA

1. Created new file `cloud-init.txt` and then added configuration to it so `inetutils-traceroute` package would be installed when creating new VM.
```bash
code cloud-init.txt
```

Then added following configuration before saving it:
```
#cloud-config
package_upgrade: true
packages:
   - inetutils-traceroute
```

2. Next i created public VM and added the custom data
```bash
az vm create \
--resource-group customroutestest \
--name public \
--vnet-name vnet \
--subnet publicsubnet \
--image Ubuntu2204 \
--admin-username azureuser \
--no-wait \
--custom-data cloud-init.txt \
--admin-password Kadgu7hbdzkyn1ax \
--size Standard_B1ms
```

3. Then i created private VM
```bash
az vm create \
--resource-group "myResourceGroupName" \
--name private \
--vnet-name vnet \
--subnet privatesubnet \
--image Ubuntu2204 \
--admin-username azureuser \
--no-wait \
--custom-data cloud-init.txt \
--admin-password (my password) \
--size Standard_B1ms
``` 

4.  Ran the linux `watch` command to check if VMs were now running:
```bash
watch -d -n 5 "az vm list \
    --resource-group customroutestest \
    --show-details \
    --query '[*].{Name:name, ProvisioningState:provisioningState, PowerState:powerState}' \
    --output table"
```

Output:

<img width="749" height="153" alt="image" src="https://github.com/user-attachments/assets/0438d115-b021-463d-9c8c-c67d2bf008cd" />

Deployment was successful.

5. Next i save the public IP address of the public VM to `PUBLICIP` variable
```bash
PUBLICIP="$(az vm list-ip-addresses \
    --resource-group customroutestest \
    --name public \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"
```

Then i saved the public IP address of the private VM to `PRIVATEIP` variable
```bash
PRIVATEIP="$(az vm list-ip-addresses \
--resource-group customroutestest \
--name private \
--query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
--output tsv)"
```

6. Next i tested traffic routing through the NVA.

Traced the route from public to private:
```bash
ssh -t -o StrictHostKeyChecking=no azureuser@$PUBLICIP 'traceroute private --type=icmp; exit'
```

Output:

<img width="904" height="158" alt="image" src="https://github.com/user-attachments/assets/1d51bbd5-475d-427a-a679-0a9b1f531752" />

Noticed that the first hop was to `10.0.2.4` in other words it hopped to private IP address of the NVA.

Second hop was to `10.0.1.4` the address of **private**.

This confirmed that i had successfully added route to the route table and linked the table to publicsubnet subnet. Now all traffic from public to private was routed through the NVA.

7. Traced the route from private to public
```bash
ssh -t -o StrictHostKeyChecking=no azureuser@$PRIVATEIP 'traceroute public --type=icmp; exit'
```

Output:

<img width="895" height="145" alt="image" src="https://github.com/user-attachments/assets/e76c58c3-1fee-4e58-ad76-a9bf4567e34b" />

Traffic went directly to public `10.0.0.4` and not through the NVA because private VM was using default routes which meant that traffic was routed directly between subnets.

Basically i configured routing between subnets to direct traffic from public internet through the dmzsubnet before it reached the private subnet.

The dmzsubnet i added to the VM prior acted as the NVA. The NVA could be configured further to detect potentially malicious requests and block them before they could reach their targets.

## Summary

Alright for this final piece of the lab, i put everything to the test. Used a `cloud-init` script to automatically install `traceroute` on 2 new VMs 1 public and 1 private so i wouldnt have to manually install stuff later. Once they were up i ran a traceroute from the public VM to the private one. It was a success because the first hop it hit was `10.0.2.4` which is the NVA. This proves my Route Table was actually forcing the traffic through the DMZ instead of just letting it go direct.

I also tested the reverse path from private to public and noticed it went straight there without hitting the NVA. This was expected because i had only linked my custom route table to the public subnet so the private subnet was still just using Azures free for all default system routes.

## What i learned

* Cloud-init is a lifesaver: You can basically "pre-configure" your VMs with tools like traceroute right at the moment of creation using the `--custom-data` flag.
* Traceroute doesnt lie: Its the best way to verify an NVA setup. If you dont see that intermediate IP address as the first hop, your routing logic is wrong.
* Routing is a 1-way street: Learned that just because traffic is forced through an NVA in one direction doesnt mean the return traffic or the other subnets traffic will follow suit. You have to be specific with which subnets you associate the Route Table to.
* The Wait and Watch combination: Using `--no-wait` during VM creation combined with the Linux `watch` command is a much smoother way to handle deployments in the CLI rather than just sitting there waiting for a prompt to return.
* Proof of Concept: This lab really drove home how you can build a security sandwich where traffic must pass through a firewall (NVA) before it touches your sensitive private backend.
