# Lab 1 Continuation: Refactoring Bicep to use modules.

1. Opened up VSC and created a new folder `modules` in the `Bicep Projects` folder.
   * Added a new filed called `appService.bicep`.

2. Copied from `main.bicep` and pasted the following into the `appService.bicep`:
```Bicep
param location string
param appServiceAppName string

@allowed([
  'nonprod'
  'prod'
])
param environmentType string

var appServicePlanName = 'toy-product-launch-plan'
var appServicePlanSkuName = (environmentType == 'prod') ? 'P2v3' : 'F1'

resource appServicePlan 'Microsoft.Web/serverfarms@2024-04-01' = {
  name: appServicePlanName
  location: location
  sku: {
    name: appServicePlanSkuName
  }
}

resource appServiceApp 'Microsoft.Web/sites@2024-04-01' = {
  name: appServiceAppName
  location: location
  properties: {
    serverFarmId: appServicePlan.id
    httpsOnly: true
  }
}
```

So what did i do here?

* I moved the `App Service` logic into its own file to create reusable module for future use regarding other projects.
* Made the module self contained by defining its parameters and variables so it wouldnt rely on external data it hasnt been given.
* Added a decorator `@allowed` and subsequently `prod` and `nonprod` so i wouldnt have to remember specifics.
* Isolated resouces into folders so the code would be easier to debug/maintain therefore preventing the `main.bicep` file from becoming unmanagable.
* Ensured the code is correct at the module level and verified it by the lack of red lines in VSC.

3. Saved the file.

## Added reference to the module from parent Bicep

1. Went back to main file and deleted App Service resources as well as `appServicePlanName` and `appServicePlanSkuName` variable definitions.
2. Added following at the bottom of main file:
```Bicep
module appService 'modules/appService.bicep' = {
  name: 'appService'
  params: {
    location: location
    appServiceAppName: appServiceAppName
    environmentType: environmentType
  }
}
```

So what did i do here?

* Deleted App service resources, because i had copied those resources to `appService.bicep`.
  * Deleted `appServicePlanName` and `appServicePlanSkuName` for the same reason, with the reason being is that if i have resources both in `module` file and `main` file, there will be conflict because Azure will receive 2 instructions for the same resource name.
* Added module code where i specified the parameters for the module by referencing the parameters used in the `main.bicep`
  * Leaving the parameter for `appServiceAppName` intact means that it becomes a referencing point. So when the code is deployed it will reference `appService.bicep` file because i added module code into the `main.bicep` and specified a parameter for it.

## Added host name as output

1. Added following at the bottom of `appService.bicep`:
```Bicep
output appServiceAppHostName string = appServiceApp.properties.defaultHostName
```

This declares that output for the module will be of type `string`. The output will take its value from `defaultHostName` property of App Service app.

**NOTE!**

Since this is declared within the module file, means its going to be available only to parent file i.e `main.bicep`. 

2. Needed to return the ouput to host which deployed the file, so went back to `main.bicep` and added following to the bottom:
```Bicep
output appServiceAppHostName string = appService.outputs.appServiceAppHostName
```

So what did i do here?

* Added output to `appService.bicep` because the websites address aka host name is only generated by Azure after tthe resource is created.
* Since `appService.bicep` is a seperate file then this means its data is private. By adding the output in the module file, it makes that information "public" so that `main.bicep` could see it.
* Went back to `main.bicep` and created a matching output. This basically amplifies the value from the module so it actually shows up in the terminal or the Portal once the deployment is done.
* By using `appService.outputs.appServiceAppHostName` i told `main.bicep` exactly where to look to find the data it needs to report it back to me.

3. Verified both `appService.bicep` and `main.bicep`

`appService.bicep`

<img width="739" height="642" alt="image" src="https://github.com/user-attachments/assets/e111169f-c50c-4d34-9558-bea852eb6398" />

Success

`main.bicep`

<img width="768" height="722" alt="image" src="https://github.com/user-attachments/assets/9bc749ae-9394-4e42-8cb9-537c770b53df" />

Success

4. Created a new RG group in portal and named it `wierdtoys`

5. Deployed the file again:
```PWSL
New-AzResourceGroupDeployment `
-Name main `
-TemplateFile main.bicep `
-environmentType nonprod
```

Success

<img width="871" height="480" alt="image" src="https://github.com/user-attachments/assets/08c299cc-6d78-4a1b-8640-c12aa5579e1e" />

## Checking deployment in portal

1. 2 Successful deployments:

<img width="462" height="227" alt="image" src="https://github.com/user-attachments/assets/3b0197af-e459-4ed6-ab5b-edfadcaf0b73" />

2. Main deployment details:

<img width="605" height="230" alt="image" src="https://github.com/user-attachments/assets/ad71e7bb-89b3-46af-91a4-4c82f59effbe" />

3. Opened up `outputs` tab from the left panel to get URL and copied the following:

<img width="636" height="70" alt="image" src="https://github.com/user-attachments/assets/9c2ba078-daa6-4201-9269-14f404f69f2a" />

4. Opened up new tab and pasted said link to browser:

<img width="833" height="1032" alt="image" src="https://github.com/user-attachments/assets/06cca2f6-09a3-4920-852a-f5557b451c7b" />

I had successfully deployed the foundations for the app.

### Summary

Now that the lab is finished i can honestly say that this wasnt as scary as i initally thought, its pretty straightforward when it comes to writing bicep. Now writing modules is actually a lot easier and logical. In essence all i had to do was copy necessary resources i wanted to use from the parent file, delete said resources from the main file to avoid conflict when deploying, add module code in the module template file with necessary parameters and add host name as output to both files so the parent file could read information that would have been private otherwise in order for the deployment to work.

I learned how to create module files which i will definetly use in the future, understood how to do it and whats the logic behind it. Its a lot easier to maintain bicep this way because its seperated into clearly distinguished parts. So if i want to change parameters of variables that would apply to all the other subsequent modules i would edit main file, if i were to have a module about say VPN gateways i could just go edit that and make necessary smaller changes for it to work in the main file.
